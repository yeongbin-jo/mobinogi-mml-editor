(function(){"use strict";class d{static TPQN=480;static table={1:1920,"1.":2880,2:960,"2.":1440,3:640,"3.":960,4:480,"4.":720,6:320,"6.":480,8:240,"8.":360,12:160,"12.":240,16:120,"16.":180,24:80,"24.":120,32:60,"32.":90,48:40,"48.":60,64:30,"64.":45};static getTick(e){return d.table[e]??d.table[4]}static getLen(e){let t=e;const s=Object.keys(d.table).sort((i,r)=>d.table[r]-d.table[i]),n=[];for(;t>0;){let i=!1;for(const r of s){const c=d.table[r];if(t>=c){n.push(r),t-=c,i=!0;break}}i||(n.push("1"),t-=d.table[1])}return n}}class p{peek(){const e=this.index,t=this.next();return this.index=e,t}mml;index=0;constructor(e){this.mml=e}hasNext(){return this.index<this.mml.length}next(){if(!this.hasNext())return"";const e=this.index;let t=this.mml[this.index++].toLowerCase();if("cdefgabr".includes(t)){for(;this.index<this.mml.length&&("+-".includes(this.mml[this.index])||/[0-9]/.test(this.mml[this.index]));)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if(t==="n"){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if("otvl".includes(t)){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}const s=this.mml.substring(e,this.index);if(s.length===0){const n=this.mml[this.index]||"";return this.index++,n}return s}}class w{static INIT_OCT=4;static getOctaveString(e,t){const s=e-t;return Math.abs(s)>2?"o"+t:s===0?"":(s<0?">":"<").repeat(Math.abs(s))}static pitchToName(e){const t=(e%12+12)%12,s=Math.floor((e-t)/12)+1,n=[{base:"c",acc:0},{base:"c",acc:1},{base:"d",acc:0},{base:"d",acc:1},{base:"e",acc:0},{base:"f",acc:0},{base:"f",acc:1},{base:"g",acc:0},{base:"g",acc:1},{base:"a",acc:0},{base:"a",acc:1},{base:"b",acc:0}],{base:i,acc:r}=n[t];return{name:i+(r>0?"+".repeat(r):r<0?"-".repeat(-r):""),octave:s}}static restToMML(e){if(e<=0)return"";const t=Object.entries(d.table).map(([c,o])=>({len:c,t:o,cost:1+c.length})).sort((c,o)=>o.t-c.t),s=Array(e+1).fill(Number.POSITIVE_INFINITY),n=Array(e+1).fill(-1),i=Array(e+1).fill(-1);s[0]=0;for(let c=0;c<=e;c++)if(s[c]!==Number.POSITIVE_INFINITY)for(let o=0;o<t.length;o++){const{t:h,cost:l}=t[o],u=c+h;if(u>e)continue;const f=s[c]+l;(f<s[u]||f===s[u]&&(i[u]===-1||t[o].t>t[i[u]].t))&&(s[u]=f,n[u]=c,i[u]=o)}if(s[e]===Number.POSITIVE_INFINITY)return d.getLen(e).map(o=>"r"+o).join("");const r=[];for(let c=e;c>0;){const o=i[c];if(o<0)break;r.push(t[o].len),c=n[c]}return r.reverse(),r.map(c=>"r"+c).join("")}static noteToMML(e,t,s){const{name:n,octave:i}=this.pitchToName(e.note);let r="";r+=this.getOctaveString(t,i),e.volume!==s&&(r+="v"+e.volume);const c=d.getLen(e.duration);return c.forEach((o,h)=>{r+=n+o,h<c.length-1&&(r+="&")}),{text:r,octave:i,volume:e.volume}}static build(e,t){const s=t?.withTempo??!1;let n=t?.initOct??this.INIT_OCT,i=12,r=0;const c=[...e].sort((h,l)=>h.tick-l.tick);let o="o"+n;for(const h of c){if(h.type==="tempo"){s&&(o+="t"+h.tempo);continue}const l=h;l.tick>r&&(o+=this.restToMML(l.tick-r),r=l.tick);const{text:u,octave:f,volume:y}=this.noteToMML(l,n,i);o+=u,n=f,i=y,r=l.tick+l.duration}return o}}const k=[{lStr:"32",match:"r16.",replace:"rrr"},{lStr:"64",match:"r32.",replace:"rrr"}];function L(a){if(!a)return{firstC:"",name:"",len:""};const e=a[0].toLowerCase();if(e>="a"&&e<="g"||e==="r"){let t=1;for(;t<a.length&&(a[t]==="+"||a[t]==="-");)t++;let s=t;for(;s<a.length&&/[0-9]/.test(a[s]);)s++;return s<a.length&&a[s]==="."&&s++,{firstC:e,name:a.slice(0,t),len:a.slice(t,s)}}return{firstC:e,name:a[0],len:a.slice(1)}}function b(a,e){const t=a-e;return Math.abs(t)>2?"o"+e:(t<0?">>":"<<").slice(0,Math.abs(t))}class g extends Map{updateMapMinLength(e,t){const s=this.get(e);(s==null||t.length<s.length)&&this.set(e,t)}}class v{map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(e){this.map.clear(),this.map.set("4","")}createOptimizerMap(){return new g}getMinString(){let e="",t=Number.POSITIVE_INFINITY;for(const s of this.map.values())s.length<t&&(e=s,t=s.length);return e||""}addString(e){for(const[t,s]of this.map)this.map.set(t,s+e)}addStringInsert(e,t){for(const[s,n]of this.map){const i=Math.max(0,n.length-t);this.map.set(s,n.slice(0,i)+e+n.slice(i))}}newBuilder(e,t,s,n){const i=Math.max(0,e.length-n);return e.slice(0,i)+"l"+t+e.slice(i)+s}fixPattern(e){for(const[t,s]of e)for(const n of k)if((t===n.lStr||n.lStr==="*")&&s.endsWith(n.match)){const i=s.slice(0,s.length-n.match.length)+n.replace;e.set(t,i)}}extendPatternBuilder(e,t,s,n,i){const r=t.lastIndexOf("l");let c="4";if(r>=0){const h=t.slice(r).match(/^l([0-9]+\.?)/i);h&&(c=h[1])}const o=c.endsWith(".");if(i>0&&!o&&t.endsWith(s+"&")){const h=(parseInt(c,10)<<1)+".";if(n===String(h)){const l=String(parseInt(c,10)<<2),u=t.slice(0,t.length-1)+".",f=this.newBuilder(u,l,s,i);e.set(l,f)}}}updateBuilder(e,t,s,n,i,r,c){let o=t+n;if(e!==i){if(i===e+"."?o+=".":o+=i,c.set(i,this.newBuilder(s,i,n,r)),i.endsWith(".")){const h=i.slice(0,-1);c.set(h,this.newBuilder(s,h,n+".",r))}this.extendPatternBuilder(c,s,n,i,r)}return o}addNoteText(e,t,s){const n=new Map,i=this.getMinString(),r=new g;for(const[c,o]of this.map){const h=this.updateBuilder(c,o,i,e,t,s,n);r.set(c,h)}for(const[c,o]of n)r.updateMapMinLength(c,o);this.map=r,this.fixPattern(this.map)}insertOxPattern(e){if(this.octD!==0){const t=this.octave+this.octD;this.addStringInsert(b(this.octave,t),e),this.octave=t,this.octD=0}}insertLxPattern(e,t,s){t===""?t=this.section:t==="."&&(t=this.section+"."),this.addNoteText(e,t,s)}doPattern(e,t,s){this.insertOxPattern(s),this.insertLxPattern(e,t,s)}nextToken(e){const t=L(e),s=t.firstC;s>="a"&&s<="g"||s==="r"?(this.doPattern(t.name,t.len||"",this.tokenStack),this.tokenStack=0):(s==="o"?this.octD=parseInt(t.len||"4",10)-this.octave:s===">"?this.octD++:s==="<"?this.octD--:s==="l"?this.section=t.len||"4":this.addString(e),s==="&"&&(this.tokenStack+=e.length))}}class T{octave=4;builderList=[{builder:"",prevOct:4}];minStack(e){return e.reduce((t,s)=>t.builder.length<=s.builder.length?t:s)}addNoteToken(e){this.builderList=this.builderList.map(t=>({builder:t.builder+b(t.prevOct,this.octave)+e,prevOct:this.octave}))}addToken(e){this.builderList=this.builderList.map(t=>({...t,builder:t.builder+e}))}cleanList(){this.builderList=[this.minStack(this.builderList)]}notePattern(e,t,s){this.addNoteToken(e),this.cleanList()}nextToken(e){const t=e[0].toLowerCase();if(t>="a"&&t<="g"){const s=e.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.|)$/);if(!s){this.addToken(e);return}const n=s[1].toLowerCase(),i=s[2]||"";this.notePattern(e,n,i)}else if(t==="r")this.addToken(e);else if(t===">")this.octave++;else if(t==="<")this.octave--;else if(t==="o"){const s=e.match(/^o([0-9]+)/i);this.octave=s?parseInt(s[1],10):this.octave}else this.addToken(e)}getMinString(){return this.minStack(this.builderList).builder}}class x extends T{constructor(e){super(),this.disableNopt=e}map=new Map;addToken2(e,t,s){let n=e.builder;e.prevOct!==t&&(n+=b(e.prevOct,t)),n+=s;const i=this.map.get(t);(i==null||i.length>n.length)&&this.map.set(t,n)}static baseSemitone(e){switch(e){case"c":return 0;case"d":return 2;case"e":return 4;case"f":return 5;case"g":return 7;case"a":return 9;case"b":return 11;default:return 0}}computeMidiFrom(e,t){const s=e[0].toLowerCase();let n=0;for(let c=1;c<e.length;c++)n+=e[c]==="+"?1:e[c]==="-"?-1:0;const i=x.baseSemitone(s)+n;return 12+(t-1)*12+i}notePattern(e,t,s){for(const n of this.builderList)if(this.addToken2(n,this.octave,e),t==="b"?this.addToken2(n,this.octave+1,"c-"+s):t==="c"&&this.addToken2(n,this.octave-1,"b+"+s),!this.disableNopt&&s.length===0&&n.prevOct!==this.octave){const i=this.computeMidiFrom(t,this.octave);i>=12&&i<=108&&this.addToken2(n,n.prevOct,"n"+i)}this.builderList=[];for(const[n,i]of this.map)this.builderList.push({builder:i,prevOct:n});this.map.clear()}}class m{constructor(e){this.originalMML=e}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=m.GEN2;static mmlCache=new Map;static setDebug(e){this.debug=e}static getDebug(){return this.debug}static setOptimizeLevel(e){this.optLevel=e}toString(){return this.cachedOptimize(m.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(m.optLevel,!1)}optimizeGen2(e=!0){const t=[new v(e),new x(e)];return this.optimize(t)}cachedOptimize(e,t){const s=`${e}:${t}:${this.originalMML}`,n=m.mmlCache.get(s);if(n!=null)return n;let i;return e===m.GEN2?i=this.optimizeGen2(t):i=this.optimize([new v(t),new x(t)]),m.mmlCache.set(s,i),i}optimize(e){let t=this.originalMML;for(const s of e){const n=new p(t);for(;n.hasNext();){const i=n.next();if(!i)break;s.nextToken(i)}t=s.getMinString()}return t}}function M(a){let t=new m(a).optimizeGen2(!1);return t=O(t),t=C(t),t=I(t),t=N(t),t}function I(a){const e=new p(a),t=[],s=n=>{if(!n)return{kind:"other",name:n,len:""};const i=n[0];if(i==="r"||i==="R"){const r=n.match(/^([rR])([0-9]+\.?|\.)?/);return{kind:"rest",name:r?r[1]:"r",len:r?.[2]??""}}if(i>="A"&&i<="G"||i>="a"&&i<="g"){const r=n.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?/);if(r)return{kind:"note",name:r[1],len:r[2]??""}}return{kind:"other",name:n,len:""}};for(;e.hasNext();){const n=e.next();if(!n)break;const i=s(n);if((i.kind==="note"||i.kind==="rest")&&(i.len==="4."||i.len===".")&&e.peek()==="&"){e.next();const c=e.peek();if(c){const o=s(c),h=o.kind===i.kind,l=h&&o.name.toLowerCase()===i.name.toLowerCase();if(h&&l&&o.len==="24"){e.next();const u=i.name;t.push(u+"4","&",u+"6");continue}else{t.push(n,"&");continue}}else{t.push(n,"&");continue}}t.push(n)}return t.join("")}function N(a){const e=new p(a),t=[];let s="4";const n=i=>{if(!i)return{kind:"other",name:i,len:""};if(/^l([0-9]+\.?)/i.test(i))return{kind:"l",name:"l",len:i.match(/^l([0-9]+\.?)/i)[1]};const r=i.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?$/);if(r)return{kind:"note",name:r[1],len:r[2]??""};const c=i.match(/^([rR])([0-9]+\.?|\.)?$/);return c?{kind:"rest",name:c[1],len:c[2]??""}:{kind:"other",name:i,len:""}};for(;e.hasNext();){const i=e.next(),r=n(i);if(r.kind==="l"){s=r.len,t.push(i);continue}if(r.kind==="note"||r.kind==="rest"){const c=r.len===s,o=r.len===(s.endsWith(".")?s:s+".");if(c){t.push(r.name);continue}if(!s.endsWith(".")&&o){t.push(r.name+".");continue}t.push(i);continue}t.push(i)}return t.join("")}function O(a){const e=new p(a),t=[];for(;e.hasNext();){const s=e.next();if(s==="<"){const n=e.peek();if(!n){t.push(s);continue}const i=n.match(/^([bB])([0-9]+\.?|)$/);if(!i){t.push(s);continue}e.next();const r=i[2]||"";let c="";const o=e.peek();if(o&&/^r([0-9]+\.?|)$/i.test(o)&&(c=e.next()),e.peek()===">"){e.next(),t.push("c-"+r),c&&t.push(c);continue}else{t.push("<",n),c&&t.push(c);continue}}t.push(s)}return t.join("")}function C(a){const e=new p(a),t=[];for(;e.hasNext();){const s=e.next();if(s===">"){const n=e.peek();if(!n){t.push(s);continue}const i=n.match(/^([cC])([0-9]+\.?|)$/);if(!i){t.push(s);continue}e.next();const r=i[2]||"";let c="";const o=e.peek();if(o&&/^r([0-9]+\.?|)$/i.test(o)&&(c=e.next()),e.peek()==="<"){e.next(),t.push("b+"+r),c&&t.push(c);continue}else{t.push(">",n),c&&t.push(c);continue}}t.push(s)}return t.join("")}function P(a,e){try{const t=w.build(a,{withTempo:e?.withTempo??!1});if(!/[cdefgab][+-]*/i.test(t))return t;const n=M(t);return!n&&t?t:n}catch(t){throw t}}function z(a){return a.map(e=>({type:"note",tick:e.startTick,duration:e.durationTick,note:e.pitch,volume:e.volume??12}))}self.onmessage=a=>{const{track:e}=a.data;try{const t=z(e.notes??[]),s=P(t,{withTempo:!1})||"";self.postMessage({trackId:e.id,optimizedMML:s})}catch{self.postMessage({trackId:e.id,optimizedMML:e.mmlString||""})}}})();
