(function(){"use strict";class m{static TPQN=480;static table={1:1920,"1.":2880,2:960,"2.":1440,3:640,"3.":960,4:480,"4.":720,6:320,"6.":480,8:240,"8.":360,12:160,"12.":240,16:120,"16.":180,24:80,"24.":120,32:60,"32.":90,48:40,"48.":60,64:30,"64.":45};static getTick(e){return m.table[e]??m.table[4]}static getLen(e){let t=e;const s=Object.keys(m.table).sort((i,o)=>m.table[o]-m.table[i]),n=[];for(;t>0;){let i=!1;for(const o of s){const r=m.table[o];if(t>=r){n.push(o),t-=r,i=!0;break}}i||(n.push("1"),t-=m.table[1])}return n}}const w="[MML]",h={debug:(...c)=>b(console.debug,c),info:(...c)=>b(console.info,c),warn:(...c)=>b(console.warn,c),error:(...c)=>b(console.error,c)};function k(){try{const c=globalThis;if(typeof c<"u"&&"MML_DEBUG"in c)return c.MML_DEBUG!==!1}catch{}return!0}function b(c,e){if(k())try{c.apply(console,[w,...e])}catch{}}class g{peek(){const e=this.index,t=this.next();return this.index=e,t}mml;index=0;constructor(e){this.mml=e}hasNext(){return this.index<this.mml.length}next(){if(!this.hasNext())return"";const e=this.index;let t=this.mml[this.index++].toLowerCase();if("cdefgabr".includes(t)){for(;this.index<this.mml.length&&("+-".includes(this.mml[this.index])||/[0-9]/.test(this.mml[this.index]));)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if(t==="n"){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if("otvl".includes(t)){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}const s=this.mml.substring(e,this.index);if(s.length===0){const n=this.mml[this.index]||"";return this.index++,h.warn("Tokenizer produced empty token, forcing advance",{index:this.index}),n}return h.debug("Tokenizer.next",{start:e,end:this.index,tok:s}),s}}class T{static INIT_OCT=4;static getOctaveString(e,t){const s=e-t;return Math.abs(s)>2?"o"+t:s===0?"":(s<0?">":"<").repeat(Math.abs(s))}static pitchToName(e){const t=(e%12+12)%12,s=Math.floor((e-t)/12)+1,n=[{base:"c",acc:0},{base:"c",acc:1},{base:"d",acc:0},{base:"d",acc:1},{base:"e",acc:0},{base:"f",acc:0},{base:"f",acc:1},{base:"g",acc:0},{base:"g",acc:1},{base:"a",acc:0},{base:"a",acc:1},{base:"b",acc:0}],{base:i,acc:o}=n[t];return{name:i+(o>0?"+".repeat(o):o<0?"-".repeat(-o):""),octave:s}}static restToMML(e){if(e<=0)return"";const t=Object.entries(m.table).map(([r,a])=>({len:r,t:a,cost:1+r.length})).sort((r,a)=>a.t-r.t),s=Array(e+1).fill(Number.POSITIVE_INFINITY),n=Array(e+1).fill(-1),i=Array(e+1).fill(-1);s[0]=0;for(let r=0;r<=e;r++)if(s[r]!==Number.POSITIVE_INFINITY)for(let a=0;a<t.length;a++){const{t:l,cost:u}=t[a],d=r+l;if(d>e)continue;const p=s[r]+u;(p<s[d]||p===s[d]&&(i[d]===-1||t[a].t>t[i[d]].t))&&(s[d]=p,n[d]=r,i[d]=a)}if(s[e]===Number.POSITIVE_INFINITY){const r=m.getLen(e);return h.debug("restToMML(fallback)",{tick:e,lens:r}),r.map(a=>"r"+a).join("")}const o=[];for(let r=e;r>0;){const a=i[r];if(a<0)break;o.push(t[a].len),r=n[r]}return o.reverse(),h.debug("restToMML(DP)",{tick:e,seq:o}),o.map(r=>"r"+r).join("")}static noteToMML(e,t,s){const{name:n,octave:i}=this.pitchToName(e.note);let o="";o+=this.getOctaveString(t,i),e.volume!==s&&(o+="v"+e.volume);const r=m.getLen(e.duration);return h.debug("noteToMML",{note:e,name:n,lens:r}),r.forEach((a,l)=>{o+=n+a,l<r.length-1&&(o+="&")}),{text:o,octave:i,volume:e.volume}}static build(e,t){const s=t?.withTempo??!1;let n=t?.initOct??this.INIT_OCT,i=12,o=0;const r=[...e].sort((l,u)=>l.tick-u.tick);h.debug("MMLBuilder.build: events sorted",r.length);let a="o"+n;for(const l of r){if(l.type==="tempo"){s&&(a+="t"+l.tempo);continue}const u=l;u.tick>o&&(a+=this.restToMML(u.tick-o),o=u.tick);const{text:d,octave:p,volume:B}=this.noteToMML(u,n,i);a+=d,n=p,i=B,o=u.tick+u.duration}return h.debug("MMLBuilder.build: output length",a.length,a.slice(0,120)),a}}const I=[{lStr:"32",match:"r16.",replace:"rrr"},{lStr:"64",match:"r32.",replace:"rrr"}];function O(c){if(!c)return{firstC:"",name:"",len:""};const e=c[0].toLowerCase();if(e>="a"&&e<="g"||e==="r"){let t=1;for(;t<c.length&&(c[t]==="+"||c[t]==="-");)t++;let s=t;for(;s<c.length&&/[0-9]/.test(c[s]);)s++;return s<c.length&&c[s]==="."&&s++,{firstC:e,name:c.slice(0,t),len:c.slice(t,s)}}return{firstC:e,name:c[0],len:c.slice(1)}}function M(c,e){const t=c-e;return Math.abs(t)>2?"o"+e:(t<0?">>":"<<").slice(0,Math.abs(t))}class v extends Map{updateMapMinLength(e,t){const s=this.get(e);(s==null||t.length<s.length)&&this.set(e,t)}}class L{map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(e){this.map.clear(),this.map.set("4","")}createOptimizerMap(){return new v}getMinString(){let e="",t=Number.POSITIVE_INFINITY;for(const s of this.map.values())s.length<t&&(e=s,t=s.length);return e||""}addString(e){for(const[t,s]of this.map)this.map.set(t,s+e)}addStringInsert(e,t){for(const[s,n]of this.map){const i=Math.max(0,n.length-t);this.map.set(s,n.slice(0,i)+e+n.slice(i))}}newBuilder(e,t,s,n){const i=Math.max(0,e.length-n);return e.slice(0,i)+"l"+t+e.slice(i)+s}fixPattern(e){for(const[t,s]of e)for(const n of I)if((t===n.lStr||n.lStr==="*")&&s.endsWith(n.match)){const i=s.slice(0,s.length-n.match.length)+n.replace;e.set(t,i)}}extendPatternBuilder(e,t,s,n,i){const o=t.lastIndexOf("l");let r="4";if(o>=0){const l=t.slice(o).match(/^l([0-9]+\.?)/i);l&&(r=l[1])}const a=r.endsWith(".");if(i>0&&!a&&t.endsWith(s+"&")){const l=(parseInt(r,10)<<1)+".";if(n===String(l)){const u=String(parseInt(r,10)<<2),d=t.slice(0,t.length-1)+".",p=this.newBuilder(d,u,s,i);e.set(u,p)}}}updateBuilder(e,t,s,n,i,o,r){let a=t+n;if(e!==i){if(i===e+"."?a+=".":a+=i,r.set(i,this.newBuilder(s,i,n,o)),i.endsWith(".")){const l=i.slice(0,-1);r.set(l,this.newBuilder(s,l,n+".",o))}this.extendPatternBuilder(r,s,n,i,o)}return a}addNoteText(e,t,s){const n=new Map,i=this.getMinString(),o=new v;for(const[r,a]of this.map){const l=this.updateBuilder(r,a,i,e,t,s,n);o.set(r,l)}for(const[r,a]of n)o.updateMapMinLength(r,a);this.map=o,this.fixPattern(this.map)}insertOxPattern(e){if(this.octD!==0){const t=this.octave+this.octD;this.addStringInsert(M(this.octave,t),e),this.octave=t,this.octD=0}}insertLxPattern(e,t,s){t===""?t=this.section:t==="."&&(t=this.section+"."),this.addNoteText(e,t,s)}doPattern(e,t,s){this.insertOxPattern(s),this.insertLxPattern(e,t,s)}nextToken(e){const t=O(e),s=t.firstC;s>="a"&&s<="g"||s==="r"?(this.doPattern(t.name,t.len||"",this.tokenStack),this.tokenStack=0):(s==="o"?this.octD=parseInt(t.len||"4",10)-this.octave:s===">"?this.octD++:s==="<"?this.octD--:s==="l"?this.section=t.len||"4":this.addString(e),s==="&"&&(this.tokenStack+=e.length))}}class N{octave=4;builderList=[{builder:"",prevOct:4}];minStack(e){return e.reduce((t,s)=>t.builder.length<=s.builder.length?t:s)}addNoteToken(e){this.builderList=this.builderList.map(t=>({builder:t.builder+M(t.prevOct,this.octave)+e,prevOct:this.octave}))}addToken(e){this.builderList=this.builderList.map(t=>({...t,builder:t.builder+e}))}cleanList(){this.builderList=[this.minStack(this.builderList)]}notePattern(e,t,s){this.addNoteToken(e),this.cleanList()}nextToken(e){const t=e[0].toLowerCase();if(t>="a"&&t<="g"){const s=e.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.|)$/);if(!s){this.addToken(e);return}const n=s[1].toLowerCase(),i=s[2]||"";this.notePattern(e,n,i)}else if(t==="r")this.addToken(e);else if(t===">")this.octave++;else if(t==="<")this.octave--;else if(t==="o"){const s=e.match(/^o([0-9]+)/i);this.octave=s?parseInt(s[1],10):this.octave}else this.addToken(e)}getMinString(){return this.minStack(this.builderList).builder}}class x extends N{constructor(e){super(),this.disableNopt=e}map=new Map;addToken2(e,t,s){let n=e.builder;e.prevOct!==t&&(n+=M(e.prevOct,t)),n+=s;const i=this.map.get(t);(i==null||i.length>n.length)&&this.map.set(t,n)}static baseSemitone(e){switch(e){case"c":return 0;case"d":return 2;case"e":return 4;case"f":return 5;case"g":return 7;case"a":return 9;case"b":return 11;default:return 0}}computeMidiFrom(e,t){const s=e[0].toLowerCase();let n=0;for(let r=1;r<e.length;r++)n+=e[r]==="+"?1:e[r]==="-"?-1:0;const i=x.baseSemitone(s)+n;return 12+(t-1)*12+i}notePattern(e,t,s){for(const n of this.builderList)if(this.addToken2(n,this.octave,e),t==="b"?this.addToken2(n,this.octave+1,"c-"+s):t==="c"&&this.addToken2(n,this.octave-1,"b+"+s),!this.disableNopt&&s.length===0&&n.prevOct!==this.octave){const i=this.computeMidiFrom(t,this.octave);i>=12&&i<=108&&this.addToken2(n,n.prevOct,"n"+i)}this.builderList=[];for(const[n,i]of this.map)this.builderList.push({builder:i,prevOct:n});this.map.clear()}}class f{constructor(e){this.originalMML=e}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=f.GEN2;static mmlCache=new Map;static setDebug(e){this.debug=e}static getDebug(){return this.debug}static setOptimizeLevel(e){this.optLevel=e}toString(){return this.cachedOptimize(f.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(f.optLevel,!1)}optimizeGen2(e=!0){const t=[new L(e),new x(e)];return this.optimize(t)}cachedOptimize(e,t){const s=`${e}:${t}:${this.originalMML}`,n=f.mmlCache.get(s);if(n!=null)return n;let i;return e===f.GEN2?i=this.optimizeGen2(t):i=this.optimize([new L(t),new x(t)]),f.mmlCache.set(s,i),i}optimize(e){let t=this.originalMML;for(const s of e){const n=new g(t);for(;n.hasNext();){const i=n.next();if(!i)break;s.nextToken(i)}t=s.getMinString(),h.debug("MMLStringOptimizer.optimize phase",{opt:s.constructor.name,length:t.length})}return t}}function z(c){let t=new f(c).optimizeGen2(!1);return t=C(t),t=G(t),t=y(t),t=P(t),t}function y(c){const e=new g(c),t=[],s=n=>{if(!n)return{kind:"other",name:n,len:""};const i=n[0];if(i==="r"||i==="R"){const o=n.match(/^([rR])([0-9]+\.?|\.)?/);return{kind:"rest",name:o?o[1]:"r",len:o?.[2]??""}}if(i>="A"&&i<="G"||i>="a"&&i<="g"){const o=n.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?/);if(o)return{kind:"note",name:o[1],len:o[2]??""}}return{kind:"other",name:n,len:""}};for(;e.hasNext();){const n=e.next();if(!n)break;const i=s(n);if((i.kind==="note"||i.kind==="rest")&&(i.len==="4."||i.len===".")&&e.peek()==="&"){e.next();const r=e.peek();if(r){const a=s(r),l=a.kind===i.kind,u=l&&a.name.toLowerCase()===i.name.toLowerCase();if(l&&u&&a.len==="24"){e.next();const d=i.name;t.push(d+"4","&",d+"6");continue}else{t.push(n,"&");continue}}else{t.push(n,"&");continue}}t.push(n)}return t.join("")}function P(c){const e=new g(c),t=[];let s="4";const n=i=>{if(!i)return{kind:"other",name:i,len:""};if(/^l([0-9]+\.?)/i.test(i))return{kind:"l",name:"l",len:i.match(/^l([0-9]+\.?)/i)[1]};const o=i.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?$/);if(o)return{kind:"note",name:o[1],len:o[2]??""};const r=i.match(/^([rR])([0-9]+\.?|\.)?$/);return r?{kind:"rest",name:r[1],len:r[2]??""}:{kind:"other",name:i,len:""}};for(;e.hasNext();){const i=e.next(),o=n(i);if(o.kind==="l"){s=o.len,t.push(i);continue}if(o.kind==="note"||o.kind==="rest"){const r=o.len===s,a=o.len===(s.endsWith(".")?s:s+".");if(r){t.push(o.name);continue}if(!s.endsWith(".")&&a){t.push(o.name+".");continue}t.push(i);continue}t.push(i)}return t.join("")}function C(c){const e=new g(c),t=[];for(;e.hasNext();){const s=e.next();if(s==="<"){const n=e.peek();if(!n){t.push(s);continue}const i=n.match(/^([bB])([0-9]+\.?|)$/);if(!i){t.push(s);continue}e.next();const o=i[2]||"";let r="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(r=e.next()),e.peek()===">"){e.next(),t.push("c-"+o),r&&t.push(r);continue}else{t.push("<",n),r&&t.push(r);continue}}t.push(s)}return t.join("")}function G(c){const e=new g(c),t=[];for(;e.hasNext();){const s=e.next();if(s===">"){const n=e.peek();if(!n){t.push(s);continue}const i=n.match(/^([cC])([0-9]+\.?|)$/);if(!i){t.push(s);continue}e.next();const o=i[2]||"";let r="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(r=e.next()),e.peek()==="<"){e.next(),t.push("b+"+o),r&&t.push(r);continue}else{t.push(">",n),r&&t.push(r);continue}}t.push(s)}return t.join("")}function E(c,e){h.debug("eventsToMML: start",{events:c?.length,opts:e});try{const t=T.build(c,{withTempo:e?.withTempo??!1});if(h.debug("eventsToMML: built length",t.length,t.slice(0,120)),!/[cdefgab][+-]*/i.test(t))return h.debug("eventsToMML: no note tokens, skip optimizer"),t;const n=z(t);return h.debug("eventsToMML: optimized length",n.length,n.slice(0,120)),!n&&t?(h.warn("eventsToMML: optimizer returned empty, falling back to built"),t):n}catch(t){throw h.error("eventsToMML error",t),t}}function S(c){return c.map(e=>({type:"note",tick:e.startTick,duration:e.durationTick,note:e.pitch,volume:e.volume??12}))}self.onmessage=c=>{const{track:e}=c.data;h.debug("Worker: received track",{id:e.id,notes:e.notes?.length,mmlLen:e.mmlString?.length});try{const t=S(e.notes??[]);h.debug("Worker: events converted",t.length);const s=E(t,{withTempo:!1});h.debug("Worker: eventsToMML done",s.length);const n=e.mmlString||"",i=s&&s.length>0?s:n;i!==s&&h.warn("Worker: empty MML from converter, using fallback"),self.postMessage({trackId:e.id,optimizedMML:i})}catch(t){h.error("mmlOptimizerWorker error",t),self.postMessage({trackId:e.id,optimizedMML:e.mmlString||""})}}})();
