(function(){"use strict";class d{static TPQN=480;static table={1:1920,"1.":2880,2:960,"2.":1440,3:640,"3.":960,4:480,"4.":720,6:320,"6.":480,8:240,"8.":360,12:160,"12.":240,16:120,"16.":180,24:80,"24.":120,32:60,"32.":90,48:40,"48.":60,64:30,"64.":45};static getTick(e){return d.table[e]??d.table[4]}static getLen(e){let t=e;const s=Object.keys(d.table).sort((n,c)=>d.table[c]-d.table[n]),i=[];for(;t>0;){let n=!1;for(const c of s){const r=d.table[c];if(t>=r){i.push(c),t-=r,n=!0;break}}n||(i.push("1"),t-=d.table[1])}return i}}const k="[MML]",l={debug:(...o)=>f(console.debug,o),info:(...o)=>f(console.info,o),warn:(...o)=>f(console.warn,o),error:(...o)=>f(console.error,o)};function w(){try{const o=globalThis;if(typeof o<"u"&&"MML_DEBUG"in o)return o.MML_DEBUG!==!1}catch{}return!0}function f(o,e){if(w())try{o.apply(console,[k,...e])}catch{}}class g{peek(){const e=this.index,t=this.next();return this.index=e,t}mml;index=0;constructor(e){this.mml=e}hasNext(){return this.index<this.mml.length}next(){if(!this.hasNext())return"";const e=this.index;let t=this.mml[this.index++].toLowerCase();if("cdefgabr".includes(t)){for(;this.index<this.mml.length&&("+-".includes(this.mml[this.index])||/[0-9]/.test(this.mml[this.index]));)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if(t==="n"){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if("otvl".includes(t)){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}const s=this.mml.substring(e,this.index);if(s.length===0){const i=this.mml[this.index]||"";return this.index++,l.warn("Tokenizer produced empty token, forcing advance",{index:this.index}),i}return l.debug("Tokenizer.next",{start:e,end:this.index,tok:s}),s}}class T{static INIT_OCT=4;static getOctaveString(e,t){const s=e-t;return Math.abs(s)>2?"o"+t:s===0?"":(s<0?">":"<").repeat(Math.abs(s))}static pitchToName(e){const t=(e%12+12)%12,s=Math.floor((e-t)/12)+1,i=[{base:"c",acc:0},{base:"c",acc:1},{base:"d",acc:0},{base:"d",acc:1},{base:"e",acc:0},{base:"f",acc:0},{base:"f",acc:1},{base:"g",acc:0},{base:"g",acc:1},{base:"a",acc:0},{base:"a",acc:1},{base:"b",acc:0}],{base:n,acc:c}=i[t];return{name:n+(c>0?"+".repeat(c):c<0?"-".repeat(-c):""),octave:s}}static restToMML(e){if(e<=0)return"";const t=d.getLen(e);return l.debug("restToMML",{tick:e,lens:t}),t.map(s=>"r"+s).join("")}static noteToMML(e,t,s){const{name:i,octave:n}=this.pitchToName(e.note);let c="";c+=this.getOctaveString(t,n),e.volume!==s&&(c+="v"+e.volume);const r=d.getLen(e.duration);return l.debug("noteToMML",{note:e,name:i,lens:r}),r.forEach((a,h)=>{c+=i+a,h<r.length-1&&(c+="&")}),{text:c,octave:n,volume:e.volume}}static build(e,t){const s=t?.withTempo??!1;let i=t?.initOct??this.INIT_OCT,n=12,c=0;const r=[...e].sort((h,u)=>h.tick-u.tick);l.debug("MMLBuilder.build: events sorted",r.length);let a="o"+i;for(const h of r){if(h.type==="tempo"){s&&(a+="t"+h.tempo);continue}const u=h;u.tick>c&&(a+=this.restToMML(u.tick-c),c=u.tick);const{text:x,octave:M,volume:B}=this.noteToMML(u,i,n);a+=x,i=M,n=B,c=u.tick+u.duration}return l.debug("MMLBuilder.build: output length",a.length,a.slice(0,120)),a}}const O=[{lStr:"32",match:"r16.",replace:"rrr"},{lStr:"64",match:"r32.",replace:"rrr"}];function z(o){if(!o)return{firstC:"",name:"",len:""};const e=o[0].toLowerCase();if(e>="a"&&e<="g"||e==="r"){let t=1;for(;t<o.length&&(o[t]==="+"||o[t]==="-");)t++;let s=t;for(;s<o.length&&/[0-9]/.test(o[s]);)s++;return s<o.length&&o[s]==="."&&s++,{firstC:e,name:o.slice(0,t),len:o.slice(t,s)}}return{firstC:e,name:o[0],len:o.slice(1)}}function b(o,e){const t=o-e;return Math.abs(t)>2?"o"+e:(t<0?">>":"<<").slice(0,Math.abs(t))}class v extends Map{updateMapMinLength(e,t){const s=this.get(e);(s==null||t.length<s.length)&&this.set(e,t)}}class L{map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(e){this.map.clear(),this.map.set("4","")}createOptimizerMap(){return new v}getMinString(){let e="",t=Number.POSITIVE_INFINITY;for(const s of this.map.values())s.length<t&&(e=s,t=s.length);return e||""}addString(e){for(const[t,s]of this.map)this.map.set(t,s+e)}addStringInsert(e,t){for(const[s,i]of this.map){const n=Math.max(0,i.length-t);this.map.set(s,i.slice(0,n)+e+i.slice(n))}}newBuilder(e,t,s,i){const n=Math.max(0,e.length-i);return e.slice(0,n)+"l"+t+e.slice(n)+s}fixPattern(e){for(const[t,s]of e)for(const i of O)if((t===i.lStr||i.lStr==="*")&&s.endsWith(i.match)){const n=s.slice(0,s.length-i.match.length)+i.replace;e.set(t,n)}}extendPatternBuilder(e,t,s,i,n){const c=t.lastIndexOf("l");let r="4";if(c>=0){const h=t.slice(c).match(/^l([0-9]+\.?)/i);h&&(r=h[1])}const a=r.endsWith(".");if(n>0&&!a&&t.endsWith(s+"&")){const h=(parseInt(r,10)<<1)+".";if(i===String(h)){const u=String(parseInt(r,10)<<2),x=t.slice(0,t.length-1)+".",M=this.newBuilder(x,u,s,n);e.set(u,M)}}}updateBuilder(e,t,s,i,n,c,r){let a=t+i;if(e!==n){if(n===e+"."?a+=".":a+=n,r.set(n,this.newBuilder(s,n,i,c)),n.endsWith(".")){const h=n.slice(0,-1);r.set(h,this.newBuilder(s,h,i+".",c))}this.extendPatternBuilder(r,s,i,n,c)}return a}addNoteText(e,t,s){const i=new Map,n=this.getMinString(),c=new v;for(const[r,a]of this.map){const h=this.updateBuilder(r,a,n,e,t,s,i);c.set(r,h)}for(const[r,a]of i)c.updateMapMinLength(r,a);this.map=c,this.fixPattern(this.map)}insertOxPattern(e){if(this.octD!==0){const t=this.octave+this.octD;this.addStringInsert(b(this.octave,t),e),this.octave=t,this.octD=0}}insertLxPattern(e,t,s){t===""?t=this.section:t==="."&&(t=this.section+"."),this.addNoteText(e,t,s)}doPattern(e,t,s){this.insertOxPattern(s),this.insertLxPattern(e,t,s)}nextToken(e){const t=z(e),s=t.firstC;s>="a"&&s<="g"||s==="r"?(this.doPattern(t.name,t.len||"",this.tokenStack),this.tokenStack=0):(s==="o"?this.octD=parseInt(t.len||"4",10)-this.octave:s===">"?this.octD++:s==="<"?this.octD--:s==="l"?this.section=t.len||"4":this.addString(e),s==="&"&&(this.tokenStack+=e.length))}}class I{octave=4;builderList=[{builder:"",prevOct:4}];minStack(e){return e.reduce((t,s)=>t.builder.length<=s.builder.length?t:s)}addNoteToken(e){this.builderList=this.builderList.map(t=>({builder:t.builder+b(t.prevOct,this.octave)+e,prevOct:this.octave}))}addToken(e){this.builderList=this.builderList.map(t=>({...t,builder:t.builder+e}))}cleanList(){this.builderList=[this.minStack(this.builderList)]}notePattern(e,t,s){this.addNoteToken(e),this.cleanList()}nextToken(e){const t=e[0].toLowerCase();if(t>="a"&&t<="g"){const s=e.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.|)$/);if(!s){this.addToken(e);return}const i=s[1].toLowerCase(),n=s[2]||"";this.notePattern(e,i,n)}else if(t==="r")this.addToken(e);else if(t===">")this.octave++;else if(t==="<")this.octave--;else if(t==="o"){const s=e.match(/^o([0-9]+)/i);this.octave=s?parseInt(s[1],10):this.octave}else this.addToken(e)}getMinString(){return this.minStack(this.builderList).builder}}class p extends I{constructor(e){super(),this.disableNopt=e}map=new Map;addToken2(e,t,s){let i=e.builder;e.prevOct!==t&&(i+=b(e.prevOct,t)),i+=s;const n=this.map.get(t);(n==null||n.length>i.length)&&this.map.set(t,i)}static baseSemitone(e){switch(e){case"c":return 0;case"d":return 2;case"e":return 4;case"f":return 5;case"g":return 7;case"a":return 9;case"b":return 11;default:return 0}}computeMidiFrom(e,t){const s=e[0].toLowerCase();let i=0;for(let r=1;r<e.length;r++)i+=e[r]==="+"?1:e[r]==="-"?-1:0;const n=p.baseSemitone(s)+i;return 12+(t-1)*12+n}notePattern(e,t,s){for(const i of this.builderList)if(this.addToken2(i,this.octave,e),t==="b"?this.addToken2(i,this.octave+1,"c-"+s):t==="c"&&this.addToken2(i,this.octave-1,"b+"+s),!this.disableNopt&&s.length===0&&i.prevOct!==this.octave){const n=this.computeMidiFrom(t,this.octave);n>=12&&n<=108&&this.addToken2(i,i.prevOct,"n"+n)}this.builderList=[];for(const[i,n]of this.map)this.builderList.push({builder:n,prevOct:i});this.map.clear()}}class m{constructor(e){this.originalMML=e}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=m.GEN2;static mmlCache=new Map;static setDebug(e){this.debug=e}static getDebug(){return this.debug}static setOptimizeLevel(e){this.optLevel=e}toString(){return this.cachedOptimize(m.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(m.optLevel,!1)}optimizeGen2(e=!0){const t=[new L(e),new p(e)];return this.optimize(t)}cachedOptimize(e,t){const s=`${e}:${t}:${this.originalMML}`,i=m.mmlCache.get(s);if(i!=null)return i;let n;return e===m.GEN2?n=this.optimizeGen2(t):n=this.optimize([new L(t),new p(t)]),m.mmlCache.set(s,n),n}optimize(e){let t=this.originalMML;for(const s of e){const i=new g(t);for(;i.hasNext();){const n=i.next();if(!n)break;s.nextToken(n)}t=s.getMinString(),l.debug("MMLStringOptimizer.optimize phase",{opt:s.constructor.name,length:t.length})}return t}}function y(o){let t=new m(o).optimizeGen2(!1);return t=C(t),t=N(t),t}function C(o){const e=new g(o),t=[];for(;e.hasNext();){const s=e.next();if(s==="<"){const i=e.peek();if(!i){t.push(s);continue}const n=i.match(/^([bB])([0-9]+\.?|)$/);if(!n){t.push(s);continue}e.next();const c=n[2]||"";let r="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(r=e.next()),e.peek()===">"){e.next(),t.push("c-"+c),r&&t.push(r);continue}else{t.push("<",i),r&&t.push(r);continue}}t.push(s)}return t.join("")}function N(o){const e=new g(o),t=[];for(;e.hasNext();){const s=e.next();if(s===">"){const i=e.peek();if(!i){t.push(s);continue}const n=i.match(/^([cC])([0-9]+\.?|)$/);if(!n){t.push(s);continue}e.next();const c=n[2]||"";let r="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(r=e.next()),e.peek()==="<"){e.next(),t.push("b+"+c),r&&t.push(r);continue}else{t.push(">",i),r&&t.push(r);continue}}t.push(s)}return t.join("")}function P(o,e){l.debug("eventsToMML: start",{events:o?.length,opts:e});try{const t=T.build(o,{withTempo:e?.withTempo??!1});if(l.debug("eventsToMML: built length",t.length,t.slice(0,120)),!/[cdefgab][+-]*/i.test(t))return l.debug("eventsToMML: no note tokens, skip optimizer"),t;const i=y(t);return l.debug("eventsToMML: optimized length",i.length,i.slice(0,120)),!i&&t?(l.warn("eventsToMML: optimizer returned empty, falling back to built"),t):i}catch(t){throw l.error("eventsToMML error",t),t}}function G(o){return o.map(e=>({type:"note",tick:e.startTick,duration:e.durationTick,note:e.pitch,volume:e.volume??12}))}self.onmessage=o=>{const{track:e}=o.data;l.debug("Worker: received track",{id:e.id,notes:e.notes?.length,mmlLen:e.mmlString?.length});try{const t=G(e.notes??[]);l.debug("Worker: events converted",t.length);const s=P(t,{withTempo:!1});l.debug("Worker: eventsToMML done",s.length);const i=e.mmlString||"",n=s&&s.length>0?s:i;n!==s&&l.warn("Worker: empty MML from converter, using fallback"),self.postMessage({trackId:e.id,optimizedMML:n})}catch(t){l.error("mmlOptimizerWorker error",t),self.postMessage({trackId:e.id,optimizedMML:e.mmlString||""})}}})();
