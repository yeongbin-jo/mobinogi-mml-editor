(function(){"use strict";const d=[1,2,3,4,6,8,12,16,24,32,48,64],b=[{base:"c",acc:0},{base:"c",acc:1},{base:"d",acc:0},{base:"d",acc:1},{base:"e",acc:0},{base:"f",acc:0},{base:"f",acc:1},{base:"g",acc:0},{base:"g",acc:1},{base:"a",acc:0},{base:"a",acc:1},{base:"b",acc:0}];class f{peek(){const e=this.index,t=this.next();return this.index=e,t}mml;index=0;constructor(e){this.mml=e}hasNext(){return this.index<this.mml.length}next(){if(!this.hasNext())return"";const e=this.index;let t=this.mml[this.index++].toLowerCase();if("cdefgabr".includes(t)){for(;this.index<this.mml.length&&("+-".includes(this.mml[this.index])||/[0-9]/.test(this.mml[this.index]));)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if(t==="n"){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}else if("otvl".includes(t)){for(;this.index<this.mml.length&&/[0-9]/.test(this.mml[this.index]);)this.index++;this.index<this.mml.length&&this.mml[this.index]==="."&&this.index++}const s=this.mml.substring(e,this.index);if(s.length===0){const i=this.mml[this.index]||"";return this.index++,i}return s}}const k=[{lStr:"32",match:"r16.",replace:"rrr"},{lStr:"64",match:"r32.",replace:"rrr"}];function M(o){if(!o)return{firstC:"",name:"",len:""};const e=o[0].toLowerCase();if(e>="a"&&e<="g"||e==="r"){let t=1;for(;t<o.length&&(o[t]==="+"||o[t]==="-");)t++;let s=t;for(;s<o.length&&/[0-9]/.test(o[s]);)s++;return s<o.length&&o[s]==="."&&s++,{firstC:e,name:o.slice(0,t),len:o.slice(t,s)}}return{firstC:e,name:o[0],len:o.slice(1)}}function x(o,e){const t=o-e;return Math.abs(t)>2?"o"+e:(t<0?">>":"<<").slice(0,Math.abs(t))}class T extends Map{updateMapMinLength(e,t){const s=this.get(e);(s==null||t.length<s.length)&&this.set(e,t)}}class w{map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(){this.map.clear(),this.map.set("4","")}createOptimizerMap(){return new T}getResult(){let e="",t=Number.POSITIVE_INFINITY;for(const s of this.map.values())s.length<t&&(e=s,t=s.length);return e||""}addString(e){for(const[t,s]of this.map)this.map.set(t,s+e)}addStringInsert(e,t){for(const[s,i]of this.map){const n=Math.max(0,i.length-t);this.map.set(s,i.slice(0,n)+e+i.slice(n))}}newBuilder(e,t,s,i){const n=Math.max(0,e.length-i);return e.slice(0,n)+"l"+t+e.slice(n)+s}fixPattern(e){for(const[t,s]of e)for(const i of k)if((t===i.lStr||i.lStr==="*")&&s.endsWith(i.match)){const n=s.slice(0,s.length-i.match.length)+i.replace;e.set(t,n)}}extendPatternBuilder(e,t,s,i,n){const r=t.lastIndexOf("l");let c="4";if(r>=0){const h=t.slice(r).match(/^l([0-9]+\.?)/i);h&&(c=h[1])}const a=c.endsWith(".");if(n>0&&!a&&t.endsWith(s+"&")){const h=(parseInt(c,10)<<1)+".";if(i===String(h)){const l=String(parseInt(c,10)<<2),u=t.slice(0,t.length-1)+".",B=this.newBuilder(u,l,s,n);e.set(l,B)}}}updateBuilder(e,t,s,i,n,r,c){let a=t+i;if(e!==n){if(n===e+"."?a+=".":a+=n,c.set(n,this.newBuilder(s,n,i,r)),n.endsWith(".")){const h=n.slice(0,-1);c.set(h,this.newBuilder(s,h,i+".",r))}this.extendPatternBuilder(c,s,i,n,r)}return a}addNoteText(e,t,s){const i=new Map,n=this.getResult(),r=new T;for(const[c,a]of this.map){const h=this.updateBuilder(c,a,n,e,t,s,i);r.set(c,h)}for(const[c,a]of i)r.updateMapMinLength(c,a);this.map=r,this.fixPattern(this.map)}insertOxPattern(e){if(this.octD!==0){const t=this.octave+this.octD;this.addStringInsert(x(this.octave,t),e),this.octave=t,this.octD=0}}insertLxPattern(e,t,s){t===""?t=this.section:t==="."&&(t=this.section+"."),this.addNoteText(e,t,s)}doPattern(e,t,s){this.insertOxPattern(s),this.insertLxPattern(e,t,s)}nextToken(e){const t=M(e),s=t.firstC;s>="a"&&s<="g"||s==="r"?(this.doPattern(t.name,t.len||"",this.tokenStack),this.tokenStack=0):(s==="o"?this.octD=parseInt(t.len||"4",10)-this.octave:s===">"?this.octD++:s==="<"?this.octD--:s==="l"?this.section=t.len||"4":this.addString(e),s==="&"&&(this.tokenStack+=e.length))}}class p{octave=4;builderList=[{builder:"",prevOct:4}];map=new Map;constructor(){}minStack(e){return e.reduce((t,s)=>t.builder.length<=s.builder.length?t:s)}addToken(e){this.builderList=this.builderList.map(t=>({...t,builder:t.builder+e}))}nextToken(e){const t=e[0].toLowerCase();if(t>="a"&&t<="g"){const s=e.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.|)$/);if(!s){this.addToken(e);return}const i=s[1].toLowerCase(),n=s[2]||"";this.notePattern(e,i,n)}else if(t==="r")this.addToken(e);else if(t===">")this.octave++;else if(t==="<")this.octave--;else if(t==="o"){const s=e.match(/^o([0-9]+)/i);this.octave=s?parseInt(s[1],10):this.octave}else this.addToken(e)}getResult(){return this.minStack(this.builderList).builder}addToken2(e,t,s){let i=e.builder;e.prevOct!==t&&(i+=x(e.prevOct,t)),i+=s;const n=this.map.get(t);(n==null||n.length>i.length)&&this.map.set(t,i)}static baseSemitone(e){switch(e){case"c":return 0;case"d":return 2;case"e":return 4;case"f":return 5;case"g":return 7;case"a":return 9;case"b":return 11;default:return 0}}computeMidiFrom(e,t){const s=e[0].toLowerCase();let i=0;for(let c=1;c<e.length;c++)i+=e[c]==="+"?1:e[c]==="-"?-1:0;const n=p.baseSemitone(s)+i;return 12+(t-1)*12+n}notePattern(e,t,s){for(const i of this.builderList)if(this.addToken2(i,this.octave,e),t==="b"?this.addToken2(i,this.octave+1,"c-"+s):t==="c"&&this.addToken2(i,this.octave-1,"b+"+s),s.length===0&&i.prevOct!==this.octave){const n=this.computeMidiFrom(t,this.octave);n>=12&&n<=108&&this.addToken2(i,i.prevOct,"n"+n)}this.builderList=[];for(const[i,n]of this.map)this.builderList.push({builder:n,prevOct:i});this.map.clear()}}class L{constructor(e){this.originalMML=e}optimize(){let e=this.originalMML;const t=[new w,new p];for(const s of t){const i=new f(e);for(;i.hasNext();){const n=i.next();if(!n)break;s.nextToken(n)}e=s.getResult()}return e}}function I(o){let t=new L(o).optimize();return t=A(t),t=O(t),t=v(t),t=E(t),t}function v(o){const e=new f(o),t=[],s=i=>{if(!i)return{kind:"other",name:i,len:""};const n=i[0];if(n==="r"||n==="R"){const r=i.match(/^([rR])([0-9]+\.?|\.)?/);return{kind:"rest",name:r?r[1]:"r",len:r?.[2]??""}}if(n>="A"&&n<="G"||n>="a"&&n<="g"){const r=i.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?/);if(r)return{kind:"note",name:r[1],len:r[2]??""}}return{kind:"other",name:i,len:""}};for(;e.hasNext();){const i=e.next();if(!i)break;const n=s(i);if((n.kind==="note"||n.kind==="rest")&&(n.len==="4."||n.len===".")&&e.peek()==="&"){e.next();const c=e.peek();if(c){const a=s(c),h=a.kind===n.kind,l=h&&a.name.toLowerCase()===n.name.toLowerCase();if(h&&l&&a.len==="24"){e.next();const u=n.name;t.push(u+"4","&",u+"6");continue}else{t.push(i,"&");continue}}else{t.push(i,"&");continue}}t.push(i)}return t.join("")}function E(o){const e=new f(o),t=[];let s="4";const i=n=>{if(!n)return{kind:"other",name:n,len:""};if(/^l([0-9]+\.?)/i.test(n))return{kind:"l",name:"l",len:n.match(/^l([0-9]+\.?)/i)[1]};const r=n.match(/^([a-gA-G][+-]*)([0-9]+\.?|\.)?$/);if(r)return{kind:"note",name:r[1],len:r[2]??""};const c=n.match(/^([rR])([0-9]+\.?|\.)?$/);return c?{kind:"rest",name:c[1],len:c[2]??""}:{kind:"other",name:n,len:""}};for(;e.hasNext();){const n=e.next(),r=i(n);if(r.kind==="l"){s=r.len,t.push(n);continue}if(r.kind==="note"||r.kind==="rest"){const c=r.len===s,a=r.len===(s.endsWith(".")?s:s+".");if(c){t.push(r.name);continue}if(!s.endsWith(".")&&a){t.push(r.name+".");continue}t.push(n);continue}t.push(n)}return t.join("")}function A(o){const e=new f(o),t=[];for(;e.hasNext();){const s=e.next();if(s==="<"){const i=e.peek();if(!i){t.push(s);continue}const n=i.match(/^([bB])([0-9]+\.?|)$/);if(!n){t.push(s);continue}e.next();const r=n[2]||"";let c="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(c=e.next()),e.peek()===">"){e.next(),t.push("c-"+r),c&&t.push(c);continue}else{t.push("<",i),c&&t.push(c);continue}}t.push(s)}return t.join("")}function O(o){const e=new f(o),t=[];for(;e.hasNext();){const s=e.next();if(s===">"){const i=e.peek();if(!i){t.push(s);continue}const n=i.match(/^([cC])([0-9]+\.?|)$/);if(!n){t.push(s);continue}e.next();const r=n[2]||"";let c="";const a=e.peek();if(a&&/^r([0-9]+\.?|)$/i.test(a)&&(c=e.next()),e.peek()==="<"){e.next(),t.push("b+"+r),c&&t.push(c);continue}else{t.push(">",i),c&&t.push(c);continue}}t.push(s)}return t.join("")}function P(o){if(!o||o.length===0)return"";const e=N(o),t=I(e);return!t&&e?e:t}function C(o){if(o<=0)return"";const e=[];for(const r of d){const c=r.toString(),a=m(c);e.push({len:c,ticks:a,cost:1+c.length});const h=m(c+".");e.push({len:c+".",ticks:h,cost:1+c.length+1})}e.sort((r,c)=>c.ticks-r.ticks);const t=Array(o+1).fill(Number.POSITIVE_INFINITY),s=Array(o+1).fill(-1),i=Array(o+1).fill(-1);t[0]=0;for(let r=0;r<=o;r++)if(t[r]!==Number.POSITIVE_INFINITY)for(let c=0;c<e.length;c++){const{ticks:a,cost:h}=e[c],l=r+a;if(l>o)continue;const u=t[r]+h;(u<t[l]||u===t[l]&&(i[l]===-1||e[c].ticks>e[i[l]].ticks))&&(t[l]=u,s[l]=r,i[l]=c)}if(t[o]===Number.POSITIVE_INFINITY)return g(o).map(c=>"r"+c).join("");const n=[];for(let r=o;r>0;){const c=i[r];if(c<0)break;n.push(e[c].len),r=s[r]}return n.reverse(),n.map(r=>"r"+r).join("")}function _(o,e,t){const{name:s,octave:i}=S(o.pitch);let n="";n+=R(e,i),o.volume!==t&&(n+="v"+o.volume);let r=!1;for(const c of d){const a=c.toString();if(m(a)===o.durationTick){n+=s+(c===4?"":a),r=!0;break}if(m(a+".")===o.durationTick){n+=s+(c===4?".":a+"."),r=!0;break}}if(!r){const c=g(o.durationTick);c.forEach((a,h)=>{n+=s+a,h<c.length-1&&(n+="&")})}return{text:n,octave:i,volume:o.volume}}function N(o){let e=4,t=12,s=0;const i=[...o].sort((r,c)=>r.startTick-c.startTick);let n="o"+e;for(const r of i){r.startTick>s&&(n+=C(r.startTick-s),s=r.startTick);const{text:c,octave:a,volume:h}=_(r,e,t);n+=c,e=a,t=h,s=r.startTick+r.durationTick}return n}function R(o,e){const t=o-e;return Math.abs(t)>2?"o"+e:t===0?"":(t<0?">":"<").repeat(Math.abs(t))}function S(o){const e=(o%12+12)%12,t=Math.floor((o-e)/12)+1,{base:s,acc:i}=b[e];return{name:s+(i>0?"+".repeat(i):i<0?"-".repeat(-i):""),octave:t}}function m(o){const e=o.endsWith("."),t=e?o.slice(0,-1):o;if(!t)return e?480*1.5:480;const s=parseInt(t,10);if(isNaN(s)||s<=0)return 480;let i=480*4/s;return e&&(i*=1.5),Math.round(i)}function g(o){if(o<=0)return[];const e=[];let t=o;for(;t>0;){let s=!1;for(const i of d){const n=Math.round(2880/i);if(t>=n){e.push(i+"."),t-=n,s=!0;break}}if(!s)for(const i of d){const n=Math.round(1920/i);if(t>=n){e.push(i.toString()),t-=n,s=!0;break}}s||(e.push("64"),t-=Math.round(480*4/64))}return e}self.onmessage=o=>{const{track:e}=o.data;try{const t=P(e.notes??[])||"";self.postMessage({trackId:e.id,optimizedMML:t})}catch{self.postMessage({trackId:e.id,optimizedMML:e.mmlString||""})}}})();
